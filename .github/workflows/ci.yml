name: CI

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # Validate JSON files
      - name: Validate JSON files
        run: |
          echo "Validating .lsp.json..."
          node -e "JSON.parse(require('fs').readFileSync('.lsp.json'))"
          echo "Validating plugin.json..."
          node -e "JSON.parse(require('fs').readFileSync('.claude-plugin/plugin.json'))"
          echo "Validating hooks.json..."
          node -e "JSON.parse(require('fs').readFileSync('hooks/hooks.json'))"
          echo "All JSON files valid ✓"

      # Syntax check JavaScript hooks
      - name: Check hook syntax
        run: |
          for hook in hooks/*.js; do
            echo "Checking $hook..."
            node --check "$hook"
          done
          echo "All hooks have valid syntax ✓"

      # Install Marksman LSP
      - name: Install Marksman
        run: |
          curl -L https://github.com/artempyanykh/marksman/releases/latest/download/marksman-linux-x64 -o marksman
          chmod +x marksman
          sudo mv marksman /usr/local/bin/
          marksman --version

      # Run hooks against test file
      - name: Test hooks
        run: |
          echo "Testing validate-code-blocks..."
          node hooks/validate-code-blocks.js tests/lsp-test.md
          echo ""
          echo "Testing validate-links..."
          node hooks/validate-links.js tests/lsp-test.md
          echo ""
          echo "Testing validate-frontmatter..."
          node hooks/validate-frontmatter.js tests/lsp-test.md
          echo ""
          echo "Testing validate-claude-code..."
          node hooks/validate-claude-code.js tests/lsp-test.md
          echo ""
          echo "All hooks executed successfully ✓"
